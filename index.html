<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Mario Cont√°bil - Controle por Toque Dividido</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; overflow: hidden;
    background: #f0f4f8;
    font-family: 'Arial', sans-serif;
    touch-action: manipulation;
    user-select: none;
  }
  #info {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: #e0f2fecc;
    color: #0f4c81;
    padding: 12px 20px;
    font-weight: 700;
    text-align: center;
    z-index: 20;
    box-shadow: 0 4px 8px rgba(15,76,129,0.3);
  }
  #fase {
    position: fixed;
    top: 48px; left: 0; right: 0;
    text-align: center;
    font-weight: 600;
    color: #2563eb;
    user-select: none;
    z-index: 20;
  }
  #mensagem {
    position: fixed;
    top: 84px;
    left: 50%;
    transform: translateX(-50%);
    background: #f87171cc;
    color: white;
    font-weight: 700;
    padding: 8px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(248,113,113,0.7);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 25;
    pointer-events: none;
    user-select: none;
    max-width: 90vw;
    text-align: center;
  }
  canvas {
    display: block;
    position: fixed;
    top: 96px;
    left: 0;
    width: 100vw;
    height: calc(100vh - 96px);
    background: linear-gradient(to top, #a3cef1 0%, #f0f4f8 100%);
    border: none;
    z-index: 10;
  }
</style>
</head>
<body>
<div id="info">Pontos: 0 | Dinheiro: R$ 10.000</div>
<div id="fase">Fase: 1</div>
<div id="mensagem" role="alert" aria-live="assertive"></div>
<canvas id="game" aria-label="Jogo Mario Cont√°bil com controle por toque dividido"></canvas>

<script>
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const mensagemEl = document.getElementById('mensagem');

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playBeep(freq=440, duration=150){
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.type = 'square';
    oscillator.frequency.value = freq;
    oscillator.start();
    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
    oscillator.stop(audioCtx.currentTime + duration / 1000);
  }
  function playJump() { playBeep(880, 100); }
  function playCollect() { playBeep(660, 120); }
  function playDamage() { playBeep(220, 300); }

  function mostrarMensagem(msg) {
    mensagemEl.textContent = msg;
    mensagemEl.style.opacity = '1';
    clearTimeout(mensagemEl._timeout);
    mensagemEl._timeout = setTimeout(() => {
      mensagemEl.style.opacity = '0';
    }, 4000);
  }

  function ajustarTamanhoCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - document.getElementById('info').offsetHeight - document.getElementById('fase').offsetHeight - mensagemEl.offsetHeight;
  }
  ajustarTamanhoCanvas();
  window.addEventListener('resize', ajustarTamanhoCanvas);

  const GRAVITY = 0.7;

  let pontos = 0;
  let dinheiro = 10000;
  let faseAtual = 0;

  const player = {
    x: 50,
    y: 0,
    width: 40,
    height: 40,
    dy: 0,
    speed: 3,
    direction: 0,  // -1 para esquerda, 1 para direita, 0 parado
    onGround: false,
    color: '#0f4c81',
  };

  const fases = [
    {
      plataformas: [
        {x: 0, y: 260, width: 480, height: 40},
        {x: 150, y: 180, width: 100, height: 15},
        {x: 300, y: 120, width: 120, height: 15},
      ],
      inimigos: [
        {x: 200, y: 230, width: 30, height: 30, dx: 2, color: '#b91c1c', nome: 'Boleto Vencido'}, 
        {x: 350, y: 80, width: 30, height: 30, dx: -1.5, color: '#dc2626', nome: 'Fatura Cart√£o'},
      ],
      itens: [
        {x: 170, y: 150, width: 20, height: 20, collected: false, color: '#f59e0b', nome: "Recibo de Pagamento", valor: 500},
        {x: 370, y: 100, width: 20, height: 20, collected: false, color: '#10b981', nome: "Comprovante IR", valor: 700},
      ],
      floorHeight: 260,
    },
    {
      plataformas: [
        {x: 0, y: 260, width: 480, height: 40},
        {x: 80, y: 190, width: 120, height: 15},
        {x: 250, y: 140, width: 150, height: 15},
        {x: 450, y: 90, width: 60, height: 15},
      ],
      inimigos: [
        {x: 100, y: 160, width: 30, height: 30, dx: 1.5, color: '#b91c1c', nome: 'Conta de Luz Atrasada'},
        {x: 300, y: 110, width: 30, height: 30, dx: -2, color: '#dc2626', nome: 'Multa IPTU'},
        {x: 460, y: 50, width: 30, height: 30, dx: -1, color: '#991b1b', nome: 'Fatura Cart√£o'},
      ],
      itens: [
        {x: 100, y: 160, width: 20, height: 20, collected: false, color: '#f59e0b', nome: "Declara√ß√£o IR", valor: 800},
        {x: 270, y: 110, width: 20, height: 20, collected: false, color: '#10b981', nome: "Comprovante INSS", valor: 600},
        {x: 470, y: 60, width: 20, height: 20, collected: false, color: '#2563eb', nome: "Recibo M√©dico", valor: 400},
      ],
      floorHeight: 260,
    },
    {
      plataformas: [
        {x: 0, y: 300, width: 600, height: 40},
        {x: 100, y: 220, width: 120, height: 15},
        {x: 280, y: 170, width: 140, height: 15},
        {x: 460, y: 120, width: 100, height: 15},
        {x: 590, y: 70, width: 80, height: 15},
      ],
      inimigos: [
        {x: 120, y: 190, width: 30, height: 30, dx: 2.5, color: '#b91c1c', nome: 'Boleto Cart√£o Cr√©dito'}, 
        {x: 320, y: 140, width: 30, height: 30, dx: -2, color: '#dc2626', nome: 'Multa IPVA'},
        {x: 470, y: 90, width: 30, height: 30, dx: 1.8, color: '#991b1b', nome: 'Fatura Atrasada'},
        {x: 600, y: 40, width: 30, height: 30, dx: -1.3, color: '#7f1d1d', nome: 'Conta de √Ågua'},
      ],
      itens: [
        {x: 110, y: 190, width: 20, height: 20, collected: false, color: '#f59e0b', nome: "Comprovante FGTS", valor: 700},
        {x: 300, y: 140, width: 20, height: 20, collected: false, color: '#10b981', nome: "Declara√ß√£o M√©dico", valor: 850},
        {x: 480, y: 90, width: 20, height: 20, collected: false, color: '#2563eb', nome: "Recibo IRPF", valor: 600},
        {x: 600, y: 60, width: 20, height: 20, collected: false, color: '#8b5cf6', nome: "Comprovante Despesa", valor: 550},
      ],
      floorHeight: 300,
    }
  ];

  let plataformas = [];
  let inimigos = [];
  let itens = [];
  let floorHeight;

  let particulas = [];

  function criarParticulas(x, y, cor) {
    for(let i = 0; i < 15; i++) {
      particulas.push({
        x,
        y,
        dx: (Math.random() - 0.5) * 4,
        dy: (Math.random() - 0.5) * 4,
        radius: Math.random() * 3 + 1,
        life: 30,
        color: cor
      });
    }
  }

  function initFase(num) {
    const f = fases[num];
    plataformas = f.plataformas.map(p => ({...p}));
    inimigos = f.inimigos.map(e => ({...e}));
    itens = f.itens.map(i => ({...i}));
    floorHeight = f.floorHeight;
    player.x = 50;
    player.y = floorHeight - player.height;
    player.dy = 0;
    player.onGround = true;
    pontos = 0;
    atualizarInfo();
    document.getElementById('fase').textContent = `Fase: ${num + 1}`;
  }

  function colisao(a, b) {
    return (
      a.x < b.x + b.width &&
      a.x + a.width > b.x &&
      a.y < b.y + b.height &&
      a.y + a.height > b.y
    );
  }

  function update() {
    // Atualiza a posi√ß√£o horizontal de acordo com dire√ß√£o
    player.x += player.speed * player.direction;

    player.dy += GRAVITY;
    player.y += player.dy;

    player.onGround = false;
    for(let plat of plataformas) {
      if (
        player.x + player.width > plat.x &&
        player.x < plat.x + plat.width &&
        player.y + player.height > plat.y &&
        player.y + player.height < plat.y + plat.height + player.dy
      ) {
        player.y = plat.y - player.height;
        player.dy = 0;
        player.onGround = true;
      }
    }

    // Limites do canvas
    if(player.x < 0) player.x = 0;
    if(player.x + player.width > canvas.width) player.x = canvas.width - player.width;

    for(let enemy of inimigos) {
      enemy.x += enemy.dx;

      if(enemy.x < 0 || enemy.x + enemy.width > canvas.width) enemy.dx *= -1;

      if(colisao(player, enemy)) {
        dinheiro -= 300;
        pontos = Math.max(0, pontos - 100);
        playDamage();
        mostrarMensagem(`Voc√™ foi penalizado! ${enemy.nome} - Pague R$300 de multa.`);
        player.x -= player.speed * player.direction * 3;
        atualizarInfo();
      }
    }

    for(let item of itens) {
      if(!item.collected && colisao(player, item)) {
        item.collected = true;
        dinheiro += item.valor;
        pontos += 150;
        playCollect();
        criarParticulas(item.x + item.width/2, item.y + item.height/2, item.color);
        atualizarInfo();
      }
    }

    particulas = particulas.filter(p => p.life > 0);
    for(let p of particulas) {
      p.x += p.dx;
      p.y += p.dy;
      p.life--;
      p.radius *= 0.95;
    }

    if(player.y + player.height > floorHeight + 40) {
      player.y = floorHeight - player.height;
      player.dy = 0;
      player.onGround = true;
    }

    if(itens.every(i => i.collected)) {
      faseAtual++;
      if(faseAtual >= fases.length) {
        alert('Parab√©ns! Voc√™ terminou todas as fases!');
        faseAtual = 0;
        pontos = 0;
        dinheiro = 10000;
      } else {
        alert(`Parab√©ns! Voc√™ passou para a fase ${faseAtual + 1}`);
      }
      initFase(faseAtual);
    }
  }

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle = '#a3cef1';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    for(let plat of plataformas) {
      ctx.fillStyle = '#2563eb';
      ctx.fillRect(plat.x, plat.y, plat.width, plat.height);
      ctx.fillStyle = '#dbeafe';
      ctx.font = '14px Arial';
      if (plat.y === floorHeight) {
        ctx.fillText('Ch√£o Cont√°bil', plat.x + 10, plat.y + 25);
      } else {
        ctx.fillText('Plataforma', plat.x + 10, plat.y + 12);
      }
    }

    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.width, player.height);
    ctx.fillStyle = '#fff';
    ctx.font = '24px Arial';
    ctx.fillText('üë®‚Äçüíº', player.x + 5, player.y + 30);

    for(let enemy of inimigos) {
      ctx.fillStyle = enemy.color;
      ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
      ctx.fillStyle = '#fff';
      ctx.font = '20px Arial';
      ctx.fillText('üìÑ', enemy.x + 5, enemy.y + 22);
    }

    for(let item of itens) {
      if(!item.collected) {
        ctx.fillStyle = item.color;
        ctx.fillRect(item.x, item.y, item.width, item.height);
        ctx.fillStyle = '#000';
        ctx.font = '16px Arial';
        ctx.fillText('üìë', item.x + 2, item.y + 16);
      }
    }

    for(let p of particulas) {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2);
      ctx.fillStyle = p.color;
      ctx.fill();
    }
  }

  function atualizarInfo() {
    document.getElementById('info').textContent = `Pontos: ${pontos} | Dinheiro: R$ ${dinheiro}`;
  }

  // Controle por toque dividido:
  // Esquerda da tela -> andar esquerda
  // Direita da tela -> andar direita
  // Centro da tela -> pular
  let touchId = null;

  window.addEventListener('touchstart', e => {
    if(touchId !== null) return; // s√≥ 1 toque ativo

    const t = e.changedTouches[0];
    const x = t.clientX;
    const w = window.innerWidth;

    touchId = t.identifier;

    if (x < w * 0.33) {
      // esquerda
      player.direction = -1;
    } else if (x > w * 0.66) {
      // direita
      player.direction = 1;
    } else {
      // meio: pular
      if(player.onGround) {
        player.dy = -14;
        player.onGround = false;
        playJump();
      }
      player.direction = 0;
    }
    e.preventDefault();
  }, {passive:false});

  window.addEventListener('touchend', e => {
    for (let t of e.changedTouches) {
      if(t.identifier === touchId) {
        player.direction = 0;
        touchId = null;
        e.preventDefault();
      }
    }
  }, {passive:false});

  initFase(faseAtual);
  function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
  }
  loop();
</script>
</body>
</html>
