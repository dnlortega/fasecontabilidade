<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Mario Cont√°bil - Plataforma com Imagens e Som</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; overflow: hidden;
    background: #5c94fc; /* C√©u azul Mario */
    font-family: 'Arial', sans-serif;
    touch-action: manipulation;
    user-select: none;
  }
  #info {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: #e0f2fecc;
    color: #0f4c81;
    padding: 12px 20px;
    font-weight: 700;
    text-align: center;
    z-index: 20;
    box-shadow: 0 4px 8px rgba(15,76,129,0.3);
  }
  #fase {
    position: fixed;
    top: 48px; left: 0; right: 0;
    text-align: center;
    font-weight: 600;
    color: #2563eb;
    user-select: none;
    z-index: 20;
  }
  #mensagem {
    position: fixed;
    top: 84px;
    left: 50%;
    transform: translateX(-50%);
    background: #f87171cc;
    color: white;
    font-weight: 700;
    padding: 8px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(248,113,113,0.7);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 25;
    pointer-events: none;
    user-select: none;
    max-width: 90vw;
    text-align: center;
  }
  canvas {
    display: block;
    position: fixed;
    top: 96px;
    left: 0;
    width: 100vw;
    height: calc(100vh - 96px);
    background: transparent;
    border: none;
    z-index: 10;
  }
</style>
</head>
<body>
<div id="info">Pontos: 0 | Dinheiro: R$ 10.000</div>
<div id="fase">Fase: 1</div>
<div id="mensagem" role="alert" aria-live="assertive"></div>
<canvas id="game" aria-label="Jogo Mario Cont√°bil com controle por toque dividido"></canvas>

<script>
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const mensagemEl = document.getElementById('mensagem');

  // Imagens das plataformas estilo Mario (uso imagens p√∫blicas simples)
  const plataformaImg = new Image();
  plataformaImg.src = 'https://i.imgur.com/5v7Ra5m.png'; // bloco mario 32x32 (pode trocar se quiser)

  // Fundo (tile) de grama para ch√£o (criamos repeti√ß√£o)
  const gramaImg = new Image();
  gramaImg.src = 'https://i.imgur.com/WZ0psQK.png'; // grama 32x32 repet√≠vel

  // Som do pulo Mario
  const jumpAudio = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');

  function playJump() {
    jumpAudio.currentTime = 0;
    jumpAudio.play();
  }

  function mostrarMensagem(msg) {
    mensagemEl.textContent = msg;
    mensagemEl.style.opacity = '1';
    clearTimeout(mensagemEl._timeout);
    mensagemEl._timeout = setTimeout(() => {
      mensagemEl.style.opacity = '0';
    }, 4000);
  }

  function ajustarTamanhoCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - document.getElementById('info').offsetHeight - document.getElementById('fase').offsetHeight - mensagemEl.offsetHeight;
  }
  ajustarTamanhoCanvas();
  window.addEventListener('resize', ajustarTamanhoCanvas);

  const GRAVITY = 0.7;

  let pontos = 0;
  let dinheiro = 10000;
  let faseAtual = 0;

  const player = {
    x: 50,
    y: 0,
    width: 32,
    height: 32,
    dy: 0,
    speed: 3,
    direction: 0,  // -1 para esquerda, 1 para direita, 0 parado
    onGround: false,
    color: '#0f4c81',
  };

  const fases = [
    {
      plataformas: [
        {x: 0, y: 260, width: 480, height: 32},
        {x: 150, y: 180, width: 100, height: 32},
        {x: 300, y: 120, width: 120, height: 32},
      ],
      inimigos: [
        {x: 200, y: 230, width: 30, height: 30, dx: 2, color: '#b91c1c', nome: 'Boleto Vencido'}, 
        {x: 350, y: 80, width: 30, height: 30, dx: -1.5, color: '#dc2626', nome: 'Fatura Cart√£o'},
      ],
      itens: [
        {x: 170, y: 150, width: 20, height: 20, collected: false, color: '#f59e0b', nome: "Recibo de Pagamento", valor: 500},
        {x: 370, y: 100, width: 20, height: 20, collected: false, color: '#10b981', nome: "Comprovante IR", valor: 700},
      ],
      floorHeight: 260,
    }
  ];

  let plataformas = [];
  let inimigos = [];
  let itens = [];
  let floorHeight;

  let particulas = [];

  function criarParticulas(x, y, cor) {
    for(let i = 0; i < 15; i++) {
      particulas.push({
        x,
        y,
        dx: (Math.random() - 0.5) * 4,
        dy: (Math.random() - 0.5) * 4,
        radius: Math.random() * 3 + 1,
        life: 30,
        color: cor
      });
    }
  }

  function initFase(num) {
    const f = fases[num];
    plataformas = f.plataformas.map(p => ({...p}));
    inimigos = f.inimigos.map(e => ({...e}));
    itens = f.itens.map(i => ({...i}));
    floorHeight = f.floorHeight;
    player.x = 50;
    player.y = floorHeight - player.height;
    player.dy = 0;
    player.onGround = true;
    pontos = 0;
    atualizarInfo();
    document.getElementById('fase').textContent = `Fase: ${num + 1}`;
  }

  function colisao(a, b) {
    return (
      a.x < b.x + b.width &&
      a.x + a.width > b.x &&
      a.y < b.y + b.height &&
      a.y + a.height > b.y
    );
  }

  function update() {
    // Atualiza a posi√ß√£o horizontal de acordo com dire√ß√£o
    player.x += player.speed * player.direction;

    player.dy += GRAVITY;
    player.y += player.dy;

    player.onGround = false;
    for(let plat of plataformas) {
      if (
        player.x + player.width > plat.x &&
        player.x < plat.x + plat.width &&
        player.y + player.height > plat.y &&
        player.y + player.height < plat.y + plat.height + player.dy
      ) {
        player.y = plat.y - player.height;
        player.dy = 0;
        player.onGround = true;
      }
    }

    // Limites do canvas
    if(player.x < 0) player.x = 0;
    if(player.x + player.width > canvas.width) player.x = canvas.width - player.width;

    for(let enemy of inimigos) {
      enemy.x += enemy.dx;

      if(enemy.x < 0 || enemy.x + enemy.width > canvas.width) enemy.dx *= -1;

      if(colisao(player, enemy)) {
        dinheiro -= 300;
        pontos = Math.max(0, pontos - 100);
        mostrarMensagem(`Voc√™ foi penalizado! ${enemy.nome} - Pague R$300 de multa.`);
        player.x -= player.speed * player.direction * 3;
        atualizarInfo();
      }
    }

    for(let item of itens) {
      if(!item.collected && colisao(player, item)) {
        item.collected = true;
        dinheiro += item.valor;
        pontos += 150;
        criarParticulas(item.x + item.width/2, item.y + item.height/2, item.color);
        atualizarInfo();
      }
    }

    particulas = particulas.filter(p => p.life > 0);
    for(let p of particulas) {
      p.x += p.dx;
      p.y += p.dy;
      p.life--;
      p.radius *= 0.95;
    }

    if(player.y + player.height > floorHeight + 32) {
      player.y = floorHeight - player.height;
      player.dy = 0;
      player.onGround = true;
    }

    if(itens.every(i => i.collected)) {
      alert('Parab√©ns! Voc√™ terminou a fase!');
      initFase(faseAtual);
    }
  }

  function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Desenha o fundo - repetindo a grama
    if (gramaImg.complete) {
      const tileSize = 32;
      for(let x = 0; x < canvas.width; x += tileSize) {
        for(let y = floorHeight; y < canvas.height; y += tileSize) {
          ctx.drawImage(gramaImg, x, y, tileSize, tileSize);
        }
      }
    } else {
      ctx.fillStyle = '#0a7f00';
      ctx.fillRect(0, floorHeight, canvas.width, canvas.height - floorHeight);
    }

    // Desenha plataformas com imagem
    if(plataformaImg.complete) {
      plataformas.forEach(plat => {
        for(let x = plat.x; x < plat.x + plat.width; x += 32) {
          ctx.drawImage(plataformaImg, x, plat.y, 32, 32);
        }
      });
    } else {
      ctx.fillStyle = '#2563eb';
      plataformas.forEach(plat => {
        ctx.fillRect(plat.x, plat.y, plat.width, plat.height);
      });
    }

    // Desenha player com emoji Mario Cont√°bil
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.width, player.height);
    ctx.font = '24px Arial';
    ctx.fillText('üë®‚Äçüíº', player.x + 5, player.y + 26);

    // Desenha inimigos como boletos (documento emoji)
    inimigos.forEach(enemy => {
      ctx.fillStyle = enemy.color;
      ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
      ctx.font = '20px Arial';
      ctx.fillText('üìÑ', enemy.x + 5, enemy.y + 22);
    });

    // Desenha itens (recibos etc) como emoji üìë
    itens.forEach(item => {
      if(!item.collected) {
        ctx.fillStyle = item.color;
        ctx.fillRect(item.x, item.y, item.width, item.height);
        ctx.font = '16px Arial';
        ctx.fillText('üìë', item.x + 2, item.y + 16);
      }
    });

    // Part√≠culas
    particulas.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2);
      ctx.fillStyle = p.color;
      ctx.fill();
    });
  }

  function atualizarInfo() {
    document.getElementById('info').textContent = `Pontos: ${pontos} | Dinheiro: R$ ${dinheiro}`;
  }

  // Controle por toque dividido:
  // Esquerda da tela -> andar esquerda
  // Direita da tela -> andar direita
  // Centro da tela -> pular
  let touchId = null;

  window.addEventListener('touchstart', e => {
    if(touchId !== null) return; // s√≥ 1 toque ativo

    const t = e.changedTouches[0];
    const x = t.clientX;
    const w = window.innerWidth;

    touchId = t.identifier;

    if (x < w * 0.33) {
      // esquerda
      player.direction = -1;
    } else if (x > w * 0.66) {
      // direita
      player.direction = 1;
    } else {
      // meio: pular
      if(player.onGround) {
        player.dy = -14;
        player.onGround = false;
        playJump();
      }
      player.direction = 0;
    }
    e.preventDefault();
  }, {passive:false});

  window.addEventListener('touchend', e => {
    for (let t of e.changedTouches) {
      if(t.identifier === touchId) {
        player.direction = 0;
        touchId = null;
        e.preventDefault();
      }
    }
  }, {passive:false});

  initFase(faseAtual);
  function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
  }
  loop();
</script>
</body>
</html>
